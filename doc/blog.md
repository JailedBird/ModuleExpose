# ModuleExpose

é¡¹ç›®åœ°å€ï¼š[https://github.com/JailedBird/ModuleExpose](https://github.com/JailedBird/ModuleExpose)

ç»´åŸºæ–‡æ¡£ï¼š[https://github.com/JailedBird/ModuleExpose/wiki](https://github.com/JailedBird/ModuleExpose/wiki)

## åºè¨€

Androidæ¨¡å—åŒ–å¿…é¡»è¦è§£å†³çš„é—®é¢˜æ˜¯ *å¦‚ä½•å®ç°æ¨¡å—é—´é€šä¿¡* ï¼Ÿè€Œæ¨¡å—ä¹‹é—´é€šä¿¡å¾€å¾€éœ€è¦è·å–ç›¸åŒçš„å®ä½“ç±»å’Œæ¥å£ï¼Œé€ æˆéƒ¨åˆ†æ¶‰åŠæ¨¡å—é€šä¿¡çš„æ¥å£å’Œå®ä½“ç±»è¢«è¿«ä¸‹æ²‰åˆ°åŸºç¡€æ¨¡å—ï¼Œå¯¼è‡´ åŸºç¡€æ¨¡å—ä»£ç è†¨èƒ€ã€æ¨¡å—ä»£ç åˆ†æ•£å’Œä¸ä¾¿ç»´æŠ¤ç­‰é—®é¢˜ï¼›



ModuleExposeæ–¹æ¡ˆä½¿ç”¨æ¨¡å—æš´éœ²&ä¾èµ–æ³¨å…¥æ¡†æ¶Hiltçš„æ–¹å¼ï¼Œå®ç°æ¨¡å—é—´é€šä¿¡ï¼š

- ä½¿ç”¨æ¨¡å—æš´éœ²ï¼ˆæ¨¡å—apiåŒ–ï¼‰è§£å†³åŸºç¡€æ¨¡å—ä¸‹æ²‰é—®é¢˜
- ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶Hiltå®ç°åŸºäºæ¥å£çš„æ¨¡å—è§£è€¦æ–¹æ¡ˆ

## ç®€ä»‹

ModuleExposeï¼Œæ˜¯å°†moduleå†…éƒ¨éœ€è¦æš´éœ²çš„ä»£ç é€šè¿‡è„šæœ¬è‡ªåŠ¨æš´éœ²å‡ºæ¥ï¼›ä¸åŒäºæ‰‹åŠ¨å½¢å¼çš„æ¥å£ä¸‹æ²‰ï¼ŒModuleExposeæ˜¯ç›´æ¥å°†moduleä¸­éœ€è¦æš´éœ²çš„ä»£ç å®Œæ•´æ‹·è´åˆ°module_exposeæ¨¡å—ï¼Œè€Œmodule_exposeæ¨¡å—çš„ç”Ÿæˆã€æ‹·è´å’Œé…ç½®æ˜¯ç”±ModuleExposeè„šæœ¬è‡ªåŠ¨å®Œæˆï¼Œå¹¶ä¿è¯ç¼–è¯‘æ—¶ä¸¤è€…ä»£ç çš„å®Œå…¨åŒæ­¥ï¼›



æœ€ç»ˆï¼Œå·¥ç¨‹ä¸­åŒ…å«å¦‚ä¸‹å‡ ç±»æ ¸å¿ƒæ¨¡å—ï¼š

- åŸºç¡€æ¨¡å—ï¼šåŸºç¡€ä»£ç å°è£…ï¼Œå¯ä¾›ä»»ä½•ä¸šåŠ¡æ¨¡å—ä½¿ç”¨ï¼›

- ä¸šåŠ¡æ¨¡å—ï¼šåŒ…å«ä¸šåŠ¡åŠŸèƒ½ï¼Œä¸šåŠ¡æ¨¡å—å¯ä»¥ä¾èµ–åŸºç¡€æ¨¡å—ï¼Œä½†æ— æ³•ä¾èµ–å…¶ä»–ä¸šåŠ¡æ¨¡å—ï¼ˆé¿å…å¾ªç¯ä¾èµ–ï¼‰ï¼›
- æš´éœ²æ¨¡å—ï¼šç”±è„šæœ¬åŸºäºä¸šåŠ¡æ¨¡å—æˆ–åŸºç¡€æ¨¡å—è‡ªåŠ¨æ‹·è´ç”Ÿæˆï¼Œä¸šåŠ¡æ¨¡å—å¯ä¾èµ–å…¶ä»–æš´éœ²æ¨¡å—ï¼ˆé€šè¿‡compileOnlyæ–¹å¼ï¼Œåªå‚ä¸ç¼–è¯‘ä¸å‚ä¸æ‰“åŒ…ï¼‰ï¼Œé¿å…æ¨¡å—é€šä¿¡æ‰€éœ€çš„æ¥å£ã€æ•°æ®å®ä½“ç±»ä¸‹æ²‰åˆ°åŸºç¡€æ¨¡å—ï¼Œé€ æˆåŸºç¡€æ¨¡å—è†¨èƒ€ã€ä¸šåŠ¡æ¨¡å—æ ¸å¿ƒç±»åˆ†æ•£åˆ°åŸºç¡€æ¨¡å—ç­‰é—®é¢˜ï¼›

å¦‚å›¾æ‰€ç¤ºï¼š

![image-20231206141629690](https://zhaojunchen-1259455842.cos.ap-nanjing.myqcloud.com//imgimage-20231206141629690.png)

æ³¨æ„è¿™ç§æ–¹æ¡ˆå¹¶éåŸåˆ›ï¼ŒåŸåˆ›å‡ºå¤„å¦‚ä¸‹ï¼š

æ€è·¯åŸåˆ›ï¼š[å¾®ä¿¡Androidæ¨¡å—åŒ–æ¶æ„é‡æ„å®è·µ](https://mp.weixin.qq.com/s/6Q818XA5FaHd7jJMFBG60w)

> å…ˆå¯»æ‰¾ä»£ç è†¨èƒ€çš„åŸå› ã€‚
>
> ç¿»å¼€åŸºç¡€å·¥ç¨‹çš„ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°é™¤äº†ç¬¦åˆè®¾è®¡åˆè¡·çš„å­˜å‚¨ã€ç½‘ç»œç­‰æ”¯æŒç»„ä»¶å¤–ï¼Œè¿˜æœ‰ç›¸å½“å¤šçš„ä¸šåŠ¡ç›¸å…³ä»£ç ã€‚è¿™äº›ä»£ç æ˜¯è†¨èƒ€çš„æ¥æºã€‚ä½†ä»£ç æ€ä¹ˆæ¥çš„ï¼Œéè¦æ”¾è¿™ï¼Ÿä¸€åˆ‡ä¸åˆç†çš†æœ‰èƒŒåçš„é€»è¾‘ã€‚åœ¨ä¹‹å‰çš„æ¶æ„ä¸­ï¼Œæˆ‘ä»¬å¤§é‡ä½¿ç”¨Eventäº‹ä»¶æ€»çº¿ä½œä¸ºæ¨¡å—é—´é€šä¿¡çš„æ–¹å¼ï¼Œä¹ŸåŸºæœ¬æ˜¯å”¯ä¸€çš„æ–¹å¼ã€‚ä½¿ç”¨Eventä½œä¸ºé€šä¿¡çš„åª’ä»‹ï¼Œè‡ªç„¶è¦æœ‰å®šä¹‰å®ƒçš„åœ°æ–¹ï¼Œå¥½è®©æ¨¡å—ä¹‹é—´éƒ½èƒ½çŸ¥é“Eventç»“æ„æ˜¯æ€æ ·çš„ã€‚è¿™æ—¶å€™åŸºç¡€å·¥ç¨‹å¥½åƒå°±æˆäº†å­˜æ”¾Eventçš„å”¯ä¸€é€‰æ‹©â€”â€”Eventå®šä¹‰è¢«æ”¾åœ¨åŸºç¡€å·¥ç¨‹ä¸­ï¼›æ¥ç€ï¼Œé‡åˆ°æŸä¸ªæ¨¡å—Aæƒ³ä½¿ç”¨æ¨¡å—Bçš„æ•°æ®ç»“æ„ç±»ï¼Œæ€ä¹ˆåŠï¼ŸæŠŠç±»ä¸‹æ²‰åˆ°åŸºç¡€å·¥ç¨‹ï¼›é‡åˆ°æ¨¡å—Aæƒ³ç”¨æ¨¡å—Bçš„æŸä¸ªæ¥å£è¿”å›ä¸ªæ•°æ®ï¼ŒEventå¥½åƒä¸å¤ªé€‚åˆï¼Ÿé‚£å°±æŠŠä»£ç ä¸‹æ²‰åˆ°åŸºç¡€å·¥ç¨‹å§â€¦â€¦
>
> å°±è¿™æ ·è¶Šæ¥è¶Šå¤šçš„ä»£ç å¾ˆâ€œè‡ªç„¶çš„â€è¢«ä¸‹æ²‰åˆ°åŸºç¡€å·¥ç¨‹ä¸­ã€‚
>
> 
>
> implementationå·¥ç¨‹æä¾›é€»è¾‘çš„å®ç°ã€‚apiå·¥ç¨‹æä¾›å¯¹å¤–çš„æ¥å£å’Œæ•°æ®ç»“æ„ã€‚libraryå·¥ç¨‹ï¼Œåˆ™æä¾›è¯¥æ¨¡å—çš„ä¸€äº›å·¥å…·ç±»ã€‚



é¡¹ç›®åŸåˆ›:  [github/tyhjh/module_api](https://github.com/tyhjh/module_api)

> å¦‚æœæ¯æ¬¡æœ‰ä¸€ä¸ªæ¨¡å—è¦ä½¿ç”¨å¦ä¸€ä¸ªæ¨¡å—çš„æ¥å£éƒ½æŠŠæ¥å£å’Œç›¸å…³æ–‡ä»¶æ”¾åˆ°å…¬å…±æ¨¡å—é‡Œé¢ï¼Œé‚£ä¹ˆå…¬å…±æ¨¡å—ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”æ¯ä¸ªæ¨¡å—éƒ½ä¾èµ–äº†å…¬å…±æ¨¡å—ï¼Œéƒ½ä¾èµ–äº†ä¸€å¤§å †å¯èƒ½ä¸éœ€è¦çš„ä¸œè¥¿ï¼›
>
> æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æå–å‡ºæ¯ä¸ªæ¨¡å—æä¾›apiçš„æ–‡ä»¶æ”¾åˆ°å„ç§å•ç‹¬çš„æ¨¡å—é‡Œé¢ï¼›æ¯”å¦‚useræ¨¡å—ï¼Œæˆ‘ä»¬æŠŠå…¬å…±æ¨¡å—é‡Œé¢çš„Userå’ŒUserInfoServiceæ”¾åˆ°æ–°çš„user-apiæ¨¡å—é‡Œé¢ï¼Œè¿™æ ·å…¶ä»–æ¨¡å—ä½¿ç”¨çš„æ—¶å€™å¯ä»¥å•ç‹¬ä¾èµ–äºè¿™ä¸ªä¸“é—¨æä¾›æ¥å£çš„æ¨¡å—ï¼Œä»¥æ­¤è§£å†³å…¬å…±æ¨¡å—è†¨èƒ€çš„é—®é¢˜



æœ¬äººå·¥ä½œï¼š

- ä½¿ç”¨ktså’Œnioé‡å†™è„šæœ¬ï¼ŒåŸºäºæ€§èƒ½çš„è€ƒé‡ï¼Œå¯¹æš´éœ²è§„åˆ™å’Œç”Ÿæˆæ–¹å¼è¿›è¡Œæ”¹è¿›ï¼›è¯¦è§ [å…³äºæ€§èƒ½](#å…³äºæ€§èƒ½)
- å°†[nowinandroid](https://github.com/android/nowinandroid)é¡¹ç›®ç¼–è¯‘è„šæœ¬ç³»ç»Ÿã€Kspç‰ˆæœ¬çš„Hiltä¾èµ–æ³¨å…¥æ¡†æ¶ã€ç¤ºä¾‹å·¥ç¨‹ä¸‰è€…ç»“åˆèµ·æ¥ï¼Œå®Œå–„åŸºäº *æ¨¡å—æš´éœ²&ä¾èµ–æ³¨å…¥æ¡†æ¶* çš„æ¨¡å—è§£è€¦ç¤ºä¾‹å·¥ç¨‹ï¼›
- å°†apiæ”¹åexposeï¼ˆPSï¼šå› å†…éƒ¨é¡¹ç›®ä½¿ç”¨è¿‡ä¹‹å‰çš„apiæ–¹æ¡ˆï¼Œä¸ºé¿å…å†²çªæ‰€ä»¥æ”¹åï¼Œä¹Ÿé¿å…å’Œå¤§ä½¬é¡¹ç›®åå­—å†²çªğŸ˜˜ è„šæœ¬ä¸­äº¦å¯è‡ªå®šä¹‰å…³é”®è¯ï¼‰



æœ¯è¯­è¯´æ˜ï¼š

- [éƒ¨åˆ†åšå®¢](https://juejin.cn/post/6945413567285821453)ä¸­ç§°è¿™ç§æ–¹å¼ä¸º***æ¨¡å—apiåŒ–***ï¼Œæˆ‘è§‰å¾—è¿™æ˜¯åˆç†çš„ï¼›æœ¬æ–‡çš„è¯­å¢ƒä¸­çš„exposeå’Œapiæ˜¯ç­‰ä»·çš„æ„æ€ï¼›




## æ¨¡å—æš´éœ²

**1ã€é¡¹ç›®å¯ç”¨ktsé…ç½®**

ModuleExposeåŒæ—¶é€‚é…äº†Groovyå’ŒKtsï¼Œè¿™é‡Œä»¥ktsè„šæœ¬æ¼”ç¤ºï¼›

Groovyæ¥å…¥æ–¹å¼ï¼š

- å‚è€ƒæ–‡æ¡£ï¼šhttps://github.com/JailedBird/ModuleExpose/wiki
- å‚è€ƒé¡¹ç›®ï¼šhttps://github.com/JailedBird/ModuleExpose/tree/main/subproj/GradleSample



**2ã€å¯¼å…¥è„šæœ¬åˆ°gradleç›®å½•&ä¿®æ”¹æ¨¡æ¿**

è¯·æ‹·è´ç¤ºä¾‹å·¥ç¨‹`gradle/expose`ç›®å½•åˆ°ä¸ªäººé¡¹ç›®gradleç›®å½•ï¼Œæ‹·è´åç›®å½•å¦‚ä¸‹ï¼š

```
Path
ModuleExpose\gradle

gradle
â”‚  libs.versions.toml
â”œâ”€expose
â”‚      build_gradle_template_android
â”‚      build_gradle_template_java
â”‚      build_gradle_template_expose
â”‚      expose.gradle.kts
â””â”€wrapper
        gradle-wrapper.jar
        gradle-wrapper.properties
```

å…¶ä¸­ï¼šexpose.gradle.ktsæ˜¯æ¨¡å—æš´éœ²çš„æ ¸å¿ƒè„šæœ¬ï¼ŒåŒ…å«è‹¥å¹²å‡½æ•°å’Œé…ç½®å‚æ•°ï¼›

å…¶ä¸­ï¼šbuild_gradle_template_androidå’Œbuild_gradle_template_javaè„šæœ¬æ¨¡æ¿å› é¡¹ç›®ä¸åŒè€Œæœ‰æ‰€ä¸åŒï¼Œéœ€è¦è‡ªè¡Œæ ¹æ®é¡¹ç›®ä¿®æ”¹ï¼Œå¦åˆ™æ— æ³•ç¼–è¯‘ï¼›

- build_gradle_template_androidï¼Œç”ŸæˆAndroidæ¨¡å—çš„è„šæœ¬æ¨¡æ¿ï¼Œæ³¨æ„é«˜ç‰ˆæœ¬gradleå¿…é¡»é…ç½®namespaceï¼Œå› æ­¤æœ€å¥½ä¿ç•™%sçš„é…ç½®ï¼ˆç»†èŠ‚è§è„šæœ¬ï¼‰ï¼š

  ```
  android {
      namespace = "%s"
  }
  ```

- build_gradle_template_javaï¼Œ ç”ŸæˆJavaæ¨¡å—çš„è„šæœ¬æ¨¡æ¿ï¼Œé…ç½®è¾ƒä¸ºç®€å•ï¼›

- includeWithExposeå‡½æ•°ä½¿ç”¨build_gradle_template_androidæ¨¡æ¿ç”ŸæˆAndroid Libraryæ¨¡å—

- includeWithJavaExposeå‡½æ•°ä½¿ç”¨build_gradle_template_javaæ¨¡æ¿ç”ŸæˆJava Libraryæ¨¡å—

- build_gradle_template_exposeï¼Œä¸åŒäºbuild_gradle_template_androidã€build_gradle_template_javaçš„æ¨¡æ¿å½¢å¼çš„é…ç½®ï¼Œä½¿ç”¨includeWithExposeã€includeWithJavaExposeæ—¶ï¼Œ**ä¼šä¼˜å…ˆæ£€æŸ¥æ¨¡å—æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨build_gradle_template_expose**ï¼Œå¦‚æœå­˜åœ¨åˆ™**ä¼˜å…ˆã€ç›´æ¥**å°†build_gradle_template_exposeå†…å®¹æ‹·è´åˆ°module_expose, ä½œä¸ºbuild.gradle.kts ï¼ **ä¿ç•™è¿™ä¸ªé…ç½®çš„åŸå› åœ¨äºï¼šå¦‚æœéœ€è¦æš´éœ²çš„ç±»ï¼Œå¼•ç”¨ä¸‰æ–¹ç±»å¦‚gsonã€ä½†ä¸ä¾¿å°†ä¸‰æ–¹åº“implementationåˆ°build_gradle_template_androidï¼Œè¿™ä¼šå¯¼è‡´module_exposeç¼–è¯‘æŠ¥é”™ï¼Œå› æ­¤ä¸ºè§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œæœ€å¥½ä½¿ç”¨è‡ªå®šä¹‰module_exposeè„šæœ¬ï¼ˆæ‹·è´moduleçš„é…ç½®ã€ç¨åŠ ä¿®æ”¹å³å¯ï¼‰**

  PSï¼šæ³¨æ„è¿™å‡ ä¸ªæ¨¡æ¿éƒ½æ˜¯æ— åç¼€çš„ï¼Œktsåç¼€æ–‡ä»¶ä¼šè¢«IDEæç¤ºä¸€å¤§å †ä¸œè¥¿ï¼›

**æ³¨æ„ï¼š** Javaæ¨¡å—ç¼–è¯‘æ›´å¿«ï¼Œä½†æ˜¯ç¼ºå°‘Activityã€Contextç­‰Androidç¯å¢ƒï¼Œè¯·çµæ´»ä½¿ç”¨ï¼›å½“ç„¶æœ€çµæ´»çš„æ–¹å¼æ˜¯ä¸ºæ¯ä¸ªmodule_exposeå•ç‹¬é…ç½®build_gradle_template_expose ï¼ˆç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼‰ï¼›å¦å¤–ï¼Œå¦‚æœä¸ç”¨includeWithJavaExposeï¼Œå…¶å®build_gradle_template_javaä¹Ÿæ˜¯ä¸éœ€è¦çš„ï¼›



**3ã€settings.gradle.ktså¯¼å…¥è„šæœ¬å‡½æ•°**

æ ¹ç›®å½•settings.gradle.ktsé…ç½®å¦‚ä¸‹ï¼š

```
apply(from = "$rootDir/gradle/expose/expose.gradle.kts")
val includeWithExpose: (projectPaths: String) -> Unit by extra
val includeWithJavaExpose: (projectPaths: String) -> Unit by extra
```



**4ã€æ¨¡å—é…ç½®**

å°†éœ€è¦æš´éœ²çš„æ¨¡å—ï¼Œåœ¨settings.gradle.kts ä½¿ç”¨includeWithExposeï¼ˆæˆ–includeWithJavaExposeï¼‰å¯¼å…¥ï¼›

```
includeWithExpose(":feature:settings")
includeWithExpose(":feature:search")
```

å³å¯è‡ªåŠ¨ç”Ÿæˆæ–°æ¨¡å— `${module_expose}`ï¼›ç„¶ååœ¨æ¨¡å—æºç ç›®å½•ä¸‹åˆ›å»ºåä¸ºexposeçš„ç›®å½•ï¼Œå°†éœ€è¦æš´éœ²çš„æ–‡ä»¶æ”¾åœ¨exposeç›®å½•ä¸‹ï¼Œ exposeç›®å½•ä¸‹çš„æ–‡ä»¶å³å¯åœ¨æ–°æ¨¡å—ä¸­è‡ªåŠ¨æ‹·è´ç”Ÿæˆï¼›

ç”Ÿæˆç»†åˆ™ï¼š

1ã€ æ¨¡å—æ”¯æŒå¤šä¸ªexposeç›®å½•ï¼ˆé€’å½’ã€å«å­ç›®å½•ï¼‰åŒæ—¶æš´éœ²ï¼Œè¿™å¯ä»¥é¿å…å°†å®ä½“ç±»ï¼Œæ¥å£ç­‰å…¨éƒ¨æ”¾åœ¨å•ä¸ªexposeï¼Œçœ‹ç€å¾ˆä¹±

2ã€ exposeå†…éƒ¨çš„æ–‡ä»¶ï¼Œé»˜è®¤å…¨éƒ¨å¤åˆ¶ï¼Œä½†è„šæœ¬æä¾›äº†å¼€å…³ï¼Œå¯ä»¥è‡ªè¡Œæ›´æ”¹å¹¶é…ç½®åŸºäºæ–‡ä»¶åçš„æ‹·è´è¿‡æ»¤ï¼›



**5ã€ä½¿ç”¨module_exposeæ¨¡å—**

è¯·ä½¿ç”¨ `compileOnly` å¯¼å…¥é¡¹ç›®ï¼Œå¦‚ä¸‹ï¼š

```
compileOnly(project(mapOf("path" to ":feature:search_expose")))
```

é”™è¯¯ç”¨æ³•ï¼šä¼šå¯¼è‡´èµ„æºå†²çª

```
implementation(project(mapOf("path" to ":feature:search_expose")))
```

åŸç†è§£é‡Šï¼šcompileOnlyåªå‚ä¸ç¼–è¯‘ï¼Œä¸ä¼šè¢«æ‰“åŒ…ï¼›implementationå‚ä¸ç¼–è¯‘å’Œæ‰“åŒ…ï¼›

å› æ­¤search_exposeåªèƒ½ä½¿ç”¨compileOnlyå¯¼å…¥ï¼Œç¡®ä¿è§£è€¦çš„æ¨¡å—ä¹‹é—´å¯ä»¥è®¿é—®åˆ°ç±»å¼•ç”¨ï¼Œä½†ä¸ä¼šé€ æˆæ‰“åŒ…æ—¶2ä¸ªç±»ç›¸åŒçš„å†²çªé—®é¢˜ï¼›



**6ã€ æ·»åŠ clean module_expose**

å½“cleané¡¹ç›®ï¼Œæœ€å¥½æ˜¯èƒ½åˆ é™¤æ‰€æœ‰module_exposeç›®å½•æ‰€æœ‰ä»£ç ï¼Œè¯·åœ¨é¡¹ç›®æ ¹build.gradle.ktsä¸­æ·»åŠ å¦‚ä¸‹taskä»»åŠ¡ï¼›

```
task("clean").dependsOn("module_expose_clean")
// This task is used for delete xx_expose module
tasks.register("module_expose_clean"){
    doLast {
        println("execute clean expose")
        subprojects.forEach{ project->
            // Please exclude these project that you don't want to delete
            if(project.name.endsWith("_expose")){
                println("ModuleExpose: delete ${project.path}")
                project.projectDir.deleteRecursively()
            }
        }
    }
}
```



## ä¾èµ–æ³¨å…¥

**åŸºäºæ¨¡å—æš´éœ²çš„ç›¸å…³æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶Hiltå®ç°åŸºäºæ¥å£çš„è§£è€¦ï¼›** å½“ç„¶å¦‚æœå¤§å®¶ä¸ä½¿ç”¨HiltæŠ€æœ¯æ ˆçš„è¯ï¼Œè¿™èŠ‚å¯ä»¥è·³è¿‡ï¼›

æœ¬èŠ‚å†…å®¹ä¼šä»¥ä¸šåŠ¡æ¨¡å—searchå’Œsettingsä¸ºä¾‹ï¼Œé€šè¿‡ä»£ç å±•ç¤ºï¼š

- searchæ¨¡å—è·³è½¬åˆ°settingsæ¨¡å—ï¼Œæ‰“å¼€SettingsActivity
- settingsæ¨¡å—è·³è½¬åˆ°searchæ¨¡å—ï¼Œæ‰“å¼€SearchActivity



PSï¼šå…³äºHiltçš„é…ç½®å’Œå¯¼å…¥ï¼Œæœ¬é¡¹ç›®ç›´æ¥æ²¿ç”¨nowinandroidå·¥ç¨‹ä¸­build-logicçš„é…ç½®ï¼Œå…·ä½“é…ç½®å’Œä½¿ç”¨è¯·å‚è€ƒæœ¬é¡¹ç›®å’Œnowinandroidé¡¹ç›®ï¼›



**1ã€ åŸºæœ¬é…ç½®&å·¥ç¨‹ç»“æ„ï¼š**

![image-20231204171057867](https://zhaojunchen-1259455842.cos.ap-nanjing.myqcloud.com//imgimage-20231204171057867.png)

å¯¼å…¥è„šæœ¬ä¹‹åï¼Œä½¿ç”¨includeWithExposeå¯¼å…¥ä¸‰ä¸ªä¸šåŠ¡æ¨¡å—ï¼Œå„è‡ªç”Ÿæˆå¯¹åº”çš„module_exposeï¼›

**æ³¨æ„ï¼Œè¯·å°†`*_expose/`æ·»åŠ åˆ°gitignoreï¼Œé¿å…exposeæ¨¡å—æäº¤åˆ°git**



**2ã€ ä¸šåŠ¡æ¨¡å—æ¥å£æš´éœ²&å®ç°**

settingsæ¨¡å—exposeç›®å½•ä¸‹æš´éœ²`SettingExpose`æ¥å£ï¼Œ è„šæœ¬ä¼šè‡ªåŠ¨å°†å…¶åŒæ­¥æ‹·è´åˆ°settings_exposeä¸­å¯¹åº”exposeç›®å½•

![image-20231204171204479](https://zhaojunchen-1259455842.cos.ap-nanjing.myqcloud.com//imgimage-20231204171204479.png)



exposeimpl/SettingExposeImplå®ç°SettingExposeæ¥å£çš„å…·ä½“åŠŸèƒ½ï¼Œå®Œå–„è·³è½¬åŠŸèƒ½

```
class SettingExposeImpl @Inject constructor() : SettingExpose {
    override fun startSettingActivity(context: Context) {
        SettingsActivity.start(context)
    }
}
```



**3ã€ Hiltæ·»åŠ æ³¨å…¥æ¥å£ç»‘å®š**

ä½¿ç”¨Hiltç»‘å®šå…¨å±€å•ä¾‹SettingExposeæ¥å£å®ç°ï¼Œå…¶å¯¹åº”å®ç°ä¸ºSettingExposeImpl

![image.png](https://zhaojunchen-1259455842.cos.ap-nanjing.myqcloud.com//img1701008419851-2d972419-d0bf-4d95-8b24-9c3db6ee5cdb.png)



**4ã€ searchæ¨¡å—compileOnlyå¯¼å…¥settings_expose**

```
compileOnly(projects.feature.settingsExpose)
```

**æ³¨æ„ï¼Œæ¨¡å—æš´éœ²ä¾èµ–åªèƒ½ä½¿ç”¨compileOnly**ï¼Œä¿è¯ç¼–è¯‘æ—¶å€™èƒ½æ‰¾åˆ°å¯¹åº”æ–‡ä»¶å³å¯ï¼›å¦å¤–projects.feature.settingsExposeè¿™ç§é¡¹ç›®å¯¼å…¥æ–¹å¼ï¼Œéœ€è¦åœ¨settings.gradle.ktså¯ç”¨projectç±»å‹å®‰å…¨é…ç½®ï¼›

```
 enableFeaturePreview("TYPESAFE_PROJECT_ACCESSORS")
```



**5ã€ searchæ³¨å…¥å¹¶ä½¿ç”¨SettingExpose**

```
@AndroidEntryPoint
class SearchActivity : AppCompatActivity() {
    @Inject
    lateinit var settingExpose: SettingExpose
    
    private val listener = object : AppSettingsPopWindow.Listener {

        override fun settings() {
            settingExpose.startSettingActivity(this@SearchActivity)
        }
    }
}
```



**6ã€ å®ç°è§£è€¦**

æœ€ç»ˆå®ç°ã€searchæ¨¡å—è·³è½¬åˆ°settingsæ¨¡å—ï¼Œæ‰“å¼€SettingsActivityã€‘ï¼Œ è‡³äºã€settingsæ¨¡å—è·³è½¬åˆ°searchæ¨¡å—ï¼Œæ‰“å¼€SearchActivityã€‘çš„æ“ä½œå®Œå…¨ä¸€è‡´ï¼Œä¸é‡å¤å™è¿°äº†ï¼›



## æ€§èƒ½é—®é¢˜

***æ³¨ï¼šæµ‹è¯•è®¾å¤‡SSDä¸ºé¡¶é…PCIE4 zhitai 7100ï¼Œç£ç›˜æ€§èƒ½ä¼šå½±å“è§‚æµ‹ç»“æœï¼ˆPSï¼šé•¿æ±Ÿå­˜å‚¨ç‰›é€¼ğŸ˜˜ï¼‰***

å¼€ç¯‡æåˆ°ï¼ŒModuleExposeé€šè¿‡è„šæœ¬å®ç°è‡ªåŠ¨æš´éœ²ï¼Œå¹¶ä¿è¯ç¼–è¯‘æ—¶moduleå’Œmoudle_exposeçš„ä»£ç å®Œå…¨åŒæ­¥ï¼›é‚£æ·±ç©¶ä¸‹ModuleExpose includeWithExposeç­‰å‡½æ•°çš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿåˆä¸ºä»€ä¹ˆèƒ½ä¿è¯ä»£ç æ˜¯å®Œå…¨åŒæ­¥çš„å‘¢ï¼Ÿ

è¿™ä¸ªå’Œgradleç”Ÿå‘½å‘¨æœŸæœ‰å…³ï¼Œæˆ‘ä¸æ˜¯å¾ˆæ‡‚ï¼Œä½†å·²çŸ¥æœ‰ï¼š

- é¡¹ç›®syncæ—¶å€™ï¼Œä¼šæ‰§è¡Œsetting.gradle.ktsæ–‡ä»¶ï¼ŒåŒæ­¥å·¥ç¨‹æ¨¡å—
- é¡¹ç›®è¿è¡Œæ—¶å€™ï¼Œä¼šæ‰§è¡Œsetting.gradle.ktsæ–‡ä»¶ï¼ŒåŒæ­¥å·¥ç¨‹æ¨¡å—

setting.gradle.ktsä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„includeWithExposeå‡½æ•°ï¼Œå®ç°åŸæœ‰include moduleåŠŸèƒ½ï¼Œå¹¶ç”Ÿæˆå’Œinclude module_exposeï¼Œè¿™ä¸ªæ“ä½œåœ¨æ¯æ¬¡runè¿è¡Œéƒ½æ˜¯ä¼šæ‰§è¡Œçš„ï¼Œå› æ­¤exposeè„šæœ¬çš„å¤„ç†æ–¹å¼å’Œæ€§èƒ½ï¼Œä¼šå¯¹é¡¹ç›®ç¼–è¯‘äº§ç”Ÿæå¤§çš„å½±å“ï¼

**1ã€åˆ†æä¸‹è„šæœ¬includeWithExposeå¤„ç†ç»†èŠ‚å’Œæ€§èƒ½é—®é¢˜**

```
fun includeWithExpose(module: String, isJava: Boolean, expose: String, condition: (String) -> Boolean) {
    include(module)
    measure("Expose ${module}", true) {
        val moduleProject = project(module)
        val src = moduleProject.projectDir.absolutePath
        val des = "${src}_${MODULE_EXPOSE_TAG}"
        // generate build.gradle.kts
        generateBuildGradle(
            src, BUILD_TEMPLATE_PATH_CUSTOM, des,
            "build.gradle.kts", moduleProject.name, isJava
        )
        doSync(src, expose, condition)
        // Add module_expose to Project!
        include("${module}_${MODULE_EXPOSE_TAG}")
    }
}
```

- include moduleï¼Œè¿™ä¸ªæœ¬èº«å°±éœ€è¦åšï¼Œä¸è®¡å…¥é¢å¤–æŸè€—ï¼›
- generateBuildGradleï¼Œåˆ›å»ºmodule_exposeçš„build.gradle.ktsï¼Œæ¶‰åŠå•ä¸ªæ–‡ä»¶çš„æ‹·è´ï¼›
- doSyncï¼Œæºç æ–‡ä»¶çš„åŒæ­¥ï¼Œå¤„ç†ç¨å¾®å¤æ‚ï¼Œåç»­å•ç‹¬è¯´ï¼›
- include module_expose, è¿™ä¸ªæ“ä½œæ˜¯å°†module_expose includeåˆ°å·¥ç¨‹ï¼Œå¼€é”€å’Œinclude moduleç›¸å½“ï¼Œå®æµ‹æ— å½±å“ï¼›

æ€»ä½“çœ‹ï¼Œ é™¤ç¬¬ä¸‰æ­¥æ–‡ä»¶åŒæ­¥doSyncï¼Œå…¶ä»–çš„æ€§èƒ½æŸè€—éƒ½æ— å…³ç´§è¦ï¼›



**2ã€åˆ†æä¸‹doSyncæ–‡ä»¶åŒæ­¥çš„ç»†èŠ‚ï¼š**

```
fun doSync(src0: String, expose: String, condition: (String) -> Boolean) {
    val start = System.currentTimeMillis()
    val src = "${src0}${File.separator}src${File.separator}main"
    val des = "${src0}_${MODULE_EXPOSE_TAG}${File.separator}src${File.separator}main"
    // Do not delete
    val root = File(src)
    val pathList = mutableListOf<String>()
    if (root.exists() && root.isDirectory) {
        measure("findDirectoryByNio") {
        	// 1): ä½¿ç”¨NIO æœç´¢åç§°ä¸ºexposeç›®å½•
            findDirectoryByNIO(src, expose, pathList)
        }
    }
    pathList.forEach { copyFrom ->
        val suffix = copyFrom.removePrefix(src)
        val copyTo = des + suffix
        measure("syncDirectory $copyFrom") {
            // 2): å®ç°æ–‡ä»¶åŒæ­¥ 
            //	a) å…ˆéå†module_exposeåˆ é™¤ä¸å­˜åœ¨äºmoduleä¸­çš„æ–‡ä»¶ 
            //	b) å°†moduleä¸­çš„æ–‡ä»¶ï¼Œé€šè¿‡NIO StandardCopyOption.REPLACE_EXISTINGæ¨¡å¼ç›´æ¥æ‹·è´
            syncDirectory(copyFrom, copyTo, condition)
        }
        // 3):åˆ é™¤ç©ºç›®å½•
        measure("Delete empty dir") {
            // remove empty dirs
            deleteEmptyDir(copyTo)
        }
    }
    debug("Module $src all spend ${(System.currentTimeMillis() - start)} ms")
}
```



1)ã€ ç›®å½•æœç´¢

åŸºäºNIOå®ç°ç›®å½•éå†ï¼Œæœç´¢æ‰€æœ‰åç§°ä¸ºexposeçš„ç›®å½•ï¼›ä½¿ç”¨NIOçš„ç›´æ¥åŸå› åœ¨äºNIOçš„æ€§èƒ½è¿œé«˜äºJava IOï¼›å¼€å‘æ—¶ä½¿ç”¨Java IOåŸºäºé€’å½’æœç´¢ï¼Œè€—æ—¶12+msï¼Œè€ŒNIOè€—æ—¶1~2msï¼›ä»æ—¶é—´å¤æ‚åº¦æ¥çœ‹ï¼Œæ­¤ç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸ºNï¼ŒNä¸ºç›®å½•æ•°é‡ï¼Œå®é™…é¡¹ç›®Nä¸€èˆ¬å¾ˆå°ï¼Œè€—æ—¶å¯ä»¥å¿½ç•¥ä¸è®¡ï¼›

2ï¼‰ã€ æ–‡ä»¶åŒæ­¥

åŸºäº1çš„ç›®å½•æœç´¢ç»“æœï¼Œåœ¨exposeç›®å½•ä¸‹å®šç‚¹æ–‡ä»¶åŒæ­¥ï¼Œå¯ä»¥å‡å°‘å¾ˆå¤šå¼€é”€å’Œéå†ï¼›

aï¼‰åˆ é™¤module_expose exposeç›®å½•ä¸‹ï¼Œä¸å­˜åœ¨äºmodule exposeä¸­çš„æ–‡ä»¶ï¼Œ æ–‡ä»¶åˆ é™¤æ¯”è¾ƒè€—æ—¶ï¼Œè²Œä¼¼å•ä¸ªæ–‡ä»¶0.5msçš„æ ·å­

bï¼‰ä»¥æ›¿æ¢æ‹·è´å½¢å¼ï¼ˆ**REPLACE_EXISTING**ï¼‰ï¼Œå¤åˆ¶module exposeç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œåˆ°module_expose exposeç›®å½•ä¸‹ï¼Œæ–‡ä»¶æ‹·è´æ¯”è¾ƒè€—æ—¶ï¼Œè²Œä¼¼ä¹Ÿå·®ä¸å¤šå•ä¸ªæ–‡ä»¶0.5~1msï¼›**æ¯æ¬¡åŒæ­¥éƒ½éœ€è¦æ‹·è´ï¼Œå¾ˆä¸å®Œç¾ï¼Œåç»­æœ‰ä¼˜åŒ–æ–¹æ¡ˆ**

3ï¼‰ã€ åˆ é™¤ç©ºç›®å½•

ä¸»è¦æ˜¯ç²¾ç®€ç›®å½•ç»“æ„ï¼Œè€—æ—¶ä¸å¤šï¼›ä¸åœ¨æ„ç©ºç›®å½•å¯¹è§†è§‰å¹²æ‰°çš„ç”šè‡³å¯ä»¥å»æ‰ï¼›å¦å¤–è¿™æ˜¯åŸºäºJava IOçš„æ“ä½œï¼Œå†™ä»£ç çš„æ˜¯è¿™å—æš‚æ—¶æ²¡ä¼˜åŒ–åˆ°ï¼›



**3ã€ ä¼˜åŒ–ç†è®ºåŠæ–¹æ¡ˆ**

1ã€ ç»å¤§éƒ¨åˆ†æƒ…å†µï¼Œæˆ‘ä»¬æ˜¯ä¸ä¼šä¿®æ”¹exposeä¸­ä»»ä½•ä»£ç çš„ï¼Œå› æ­¤å¯ä»¥è®¤ä¸º **95%+** æƒ…å†µä¸‹çš„æ–‡ä»¶åŒæ­¥ï¼Œéƒ½åªæ˜¯ 2-bï¼‰ä¸­æè¿°çš„ã€æ–‡ä»¶åŒæ­¥-æ›¿æ¢æ‹·è´ã€‘æƒ…å†µï¼›å› æ­¤ç›´æ¥è¯»å–æ‹·è´æºæ–‡ä»¶ï¼Œæ‹·è´ç›®çš„æ–‡ä»¶ï¼Œå¯¹æ¯”ä»–ä»¬æ˜¯å¦å­˜åœ¨å·®å¼‚ï¼Œæ€§èƒ½æ˜¯å¦ä¼šæ›´å¥½ï¼Ÿç»è¿‡å°è¯•ï¼Œå¦‚ä¸‹æ–¹æ¡ˆæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå•ä¸ªå°æ–‡ä»¶å¤„ç†è€—æ—¶ä¸è¶…è¿‡1msï¼š

```
fun areFilesContentEqual(path1: Path, path2: Path,tag:String=""): Boolean {
    try {
        val size1 = Files.size(path1)
        val size2 = Files.size(path2)
        if (size1 != size2) {
            return false // Different sizes, files can't be equal
        }
        // å°ç»†èŠ‚ 4MBå¤§æ–‡ä»¶ç›´æ¥åˆ¤å®šä¸ç›¸åŒï¼Œé€šè¿‡æ–‡ä»¶ç³»ç»Ÿç›´æ¥æ‹·è´åŒæ­¥ é¡¹ç›®ä¸­æ˜¯ä¸å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µçš„ï¼
        if(size1 > 4_000_000){ // 4MB return false 
            return false
        }
        val start = System.currentTimeMillis()
        val content1 = Files.readAllBytes(path1) // Huge file will cause performance problem
        val content2 = Files.readAllBytes(path2)
        val isSame = content1.contentEquals(content2)
        debug("$tag Read ${path1.fileName}*2 & FilesContentEqual spend ${System.currentTimeMillis()-start} ms, isSame $isSame")
        return isSame
    } catch (e: Exception) {
        e.printStackTrace()
    }
    return false
}

```

å…ˆåˆ¤å®šå†…å®¹æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´æ‰è¿›è¡Œæ‹·è´ã€**ç®—æ˜¯å¢é‡ç¼–è¯‘äº†å§ğŸ¤£**ã€‘ï¼›å®æµ‹é’ˆå¯¹æ™®é€šæ–‡ä»¶è¯»æ–‡ä»¶å’Œæ¯”è¾ƒè€—æ—¶å°äº**1ms**ï¼

```
if(areFilesContentEqual(file,destinationFile, "[directorySync]")){
    // Do nothing
}else{
    measure("[directorySync] ${file.fileName} sync with copy REPLACE_EXISTING",true) {
        Files.copy(
            file,
            destinationFile,
            StandardCopyOption.REPLACE_EXISTING
        )
    }

}
```



2ã€ æ”¹è¿›ç‚¹ï¼Œçœ‹ä¸‹è€æ–¹æ¡ˆå§ï¼Œ a) é’ˆå¯¹èŒƒå›´è¿‡å¤§ï¼Œæœªç»†åŒ–ç›®å½•ï¼›b) é’ˆå¯¹apiåç¼€çš„ç›®å½•ï¼Œè¿™ä¸ªæ ¼å¼ä¸æ˜¯å¾ˆçµæ´»ï¼›

```
https://github.com/tyhjh/module_api#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0
def includeWithApi(String moduleName) {
    //å…ˆæ­£å¸¸åŠ è½½è¿™ä¸ªæ¨¡å—
    include(moduleName)
    // æ¯æ¬¡ç¼–è¯‘åˆ é™¤ä¹‹å‰çš„æ–‡ä»¶
    deleteDir(targetDir)
    //å¤åˆ¶.apiæ–‡ä»¶åˆ°æ–°çš„è·¯å¾„
    copy() {
        from originDir
        into targetDir
        exclude '**/build/'
        exclude '**/res/'
        include '**/*.api'
    }
}
```

å¯¹æ¯”çœ‹ä¸‹æˆ‘çš„è¾“å‡ºç»“æœï¼ŒäºŒæ¬¡ç¼–è¯‘æƒ…å†µä¸‹è€—æ—¶ï¼Œåªèƒ½è¯´ç›¸å¯¹å®Œç¾ å“ˆå“ˆğŸ˜˜ï¼ˆæµ‹è¯•tagï¼šrelease-1.0.0-betaï¼‰

```
ModuleExpose :core:common spend 2ms
ModuleExpose :feature:settings spend 2ms
ModuleExpose :feature:search spend 2ms
ModuleExpose :feature:about spend 2ms
```

æç«¯æƒ…å†µä¸‹æµ‹è¯•ï¼šåœ¨settingsæ¨¡å—exposeç›®å½•ä¸‹æ·»åŠ 100ä¸ªå†…å®¹ä¸ºexpose.gradle.ktsçš„æ–‡ä»¶ï¼Œå•æ–‡ä»¶480è¡Œã€16.2 KBï¼›

åˆ†åˆ«æµ‹è¯•é¦–æ¬¡ç¼–è¯‘ã€æºç ä¸å˜æƒ…å†µä¸‹çš„äºŒæ¬¡ç¼–è¯‘ã€ä¿®æ”¹å•ä¸ªæ–‡ä»¶çš„äºŒæ¬¡ç¼–è¯‘ï¼Œè€—æ—¶å¦‚ä¸‹ï¼š

```
ModuleExpose :feature:settings spend 80ms
ModuleExpose :feature:settings spend 32ms
ModuleExpose :feature:settings spend 34ms 
// å¯ä»¥çœ‹å‡ºæºç ä¿®æ”¹çš„è€—æ—¶ ä»‹äºé¦–æ¬¡ç¼–è¯‘ ~ æºç ä¸å˜æƒ…å†µä¸‹çš„äºŒæ¬¡ç¼–è¯‘ä¹‹é—´ ä¸”è€—æ—¶å’Œä¿®æ”¹å†…å®¹æˆæ­£æ¯”ï¼
```

**ç»¼ä¸Šï¼šæ€§èƒ½è¿˜æ˜¯éå¸¸ä¼˜ç§€çš„ï¼Œè¯·å¤§å®¶æ”¾å¿ƒé£Ÿç”¨ğŸ˜˜**





3ã€å¦å¤–ï¼Œå¦‚æœé¡¹ç›®ä¸­æ¨¡å—æš´éœ²çš„æ–‡ä»¶å·²ç»å¤šåˆ°å½±å“ç¼–è¯‘ï¼Œé‚£ä¹ˆå»ºè®®ç›´æ¥å°†æš´éœ²çš„æ¨¡å—ï¼Œå•ç‹¬æŠ½å‡ºæ¥ä¸ºçœŸæ­£çš„æ¨¡å—ï¼š

- module_exposeæœ¬å°±æ¥è‡ªmoduleï¼Œç”šè‡³åŒ…åéƒ½æ²¡å˜ï¼Œç›´æ¥å°†å…¶ä½œä¸ºç‹¬ç«‹æ¨¡å—æ˜¯å®Œå…¨æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯è¦æ³¨æ„å°†å…¶æ·»åŠ åˆ°gitä¸­å»ã€å½“ç„¶æœ€å¥½æ”¹ä¸ªåå­—å§
- åˆ é™¤moduleä¸­exposeçš„å†…å®¹ï¼Œç„¶åç›´æ¥implement module_exposeï¼Œå…¶ä»–compileOnly module_expose ç›´æ¥æœç´¢æ›¿æ¢ä¸ºimplement module_exposeå³å¯ï¼›
- ä½¿ç”¨includeè€ŒéincludeWithExposeå¯¼å…¥moduleï¼Œé¿å…è‡ªåŠ¨ç”Ÿæˆmodule_exposeï¼›

Okï¼Œå‡ ä¹é›¶æˆæœ¬æ‹†é™¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç›¸æ¯”åŸåˆ›é¡¹ç›®è¦å°†æš´éœ²å†…å®¹é›†ä¸­æ”¶æ•›åˆ°exposeç›®å½•â€”â€”**ä¾¿äºé›†ä¸­ç®¡ç†å’ŒåæœŸè¿ç§»**



**ç»¼ä¸Šï¼Œç»ç»ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå³å·²ç”Ÿæˆmodule_exposeå¹¶ä¸”exposeç›®å½•å†…å®¹æ— ä»»ä½•å˜åŒ–ï¼ŒModuleExposeé¢å¤–æ€§èƒ½å¼€é”€çº¦ä¸ºï¼š2Nä¸ªæ–‡ä»¶è¯»è€—æ—¶+è¿™2Nä¸ªæ–‡ä»¶å†…å®¹çš„ByteArrayå¯¹è±¡çš„contentEqualsè€—æ—¶ï¼å…¶ä¸­Nä¸ºmoduleä¸­exposeç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡**



**é™¤MoudleExposeæœ¬èº«çš„å¼€é”€ï¼Œè¿˜éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæºç ä¸å˜æƒ…å†µä¸‹æ¯æ¬¡è¿è¡Œï¼ŒmoduleåŒæ­¥åˆ°module_exposeï¼Œæ˜¯å¦ä¼šç ´åTransformã€æ³¨è§£å¤„ç†å™¨ã€æ¨¡å—ç¼–è¯‘ç­‰å¢é‡ç¼–è¯‘æœºåˆ¶ï¼Œè¿›è€Œå¯¼è‡´å…¶ä»–çš„ç¼–è¯‘è€—æ—¶é—®é¢˜å‘¢ï¼Ÿ**

- åœ¨ä¹‹å‰ä¸åšæ–‡ä»¶å†…å®¹æ ¡éªŒï¼Œç›´æ¥æ‹·è´å¤åˆ¶çš„æƒ…å†µä¸‹ï¼Œè™½ç„¶æ‹·è´å‰åæ–‡ä»¶å†…å®¹å®Œå…¨ä¸€è‡´ï¼Œä½†æ˜¯ä»æ–‡ä»¶ç®¡ç†å™¨å¯ä»¥çœ‹å‡ºå…¶æ–‡ä»¶åˆ›å»ºæ—¶é—´æ˜¯å˜åŒ–äº†çš„ï¼›å› ä¸ºå¯¹gradleçš„ç¼–è¯‘æœºåˆ¶ä¸ç†Ÿæ‚‰ï¼Œæ‰€ä»¥æˆ‘ä¸ç¡®å®šä»–æ˜¯å¦è§¦å‘äº†module_exposeçš„é‡æ–°ç¼–è¯‘ã€ä»¥åŠå…¶ä»–å¯èƒ½çš„å‰¯ä½œç”¨ï¼›ã€æŒ‰ç†æ¥è¯´å¯ä»¥ä¸é‡æ–°ç¼–è¯‘ï¼Œä½†æ˜¯æ–‡ä»¶æ—¶é—´æˆ³ç¡®å®åˆå˜äº†ğŸ¤£ã€‘
- å¯ç”¨æ–‡ä»¶å†…å®¹æ ¡éªŒçš„æƒ…å†µä¸‹ï¼Œmodule_exposeä¸­çš„æ–‡ä»¶ä¹Ÿä¸ä¼šè¢«é‡æ–°ç”Ÿæˆï¼Œä»ä»»åŠ¡ç®¡ç†å™¨çœ‹æ–‡ä»¶æœ¬èº«ã€buildæ–‡ä»¶å¤¹ç­‰çš„åˆ›å»ºæ—¶é—´ä¹Ÿæœªå˜åŒ–ï¼Œå› æ­¤å§‘ä¸”å¯ä»¥æ–­å®š **æœ€ç»ˆçš„ModuleExposeä¸ä¼šç ´åç›¸å…³çš„å¢é‡æœºåˆ¶ï¼Œé€ æˆå…¶ä»–æ€§èƒ½é—®é¢˜**ï¼› ï¼ˆæœ‰äº†è§£è¿™ä¸ªçš„å¤§ä½¬ä¹Ÿæ¬¢è¿æŒ‡æ­£ï¼ï¼‰

ç¼–è¯‘æ—¥å¿—å¦‚ä¸‹ï¼Œçœ‹èµ·æ¥ç¡®å®æ˜¯ä¸ä¼šé€ æˆé‡æ–°ç¼–è¯‘ç­‰é—®é¢˜ï¼›

```
> Task :feature:search:kspProDebugKotlin UP-TO-DATE
> Task :feature:search:compileProDebugKotlin UP-TO-DATE
> Task :feature:search:javaPreCompileProDebug UP-TO-DATE
> Task :feature:search:compileProDebugJavaWithJavac UP-TO-DATE
> Task :feature:search_expose:preBuild UP-TO-DATE
> Task :feature:search_expose:preProDebugBuild UP-TO-DATE
> Task :feature:search_expose:generateProDebugBuildConfig UP-TO-DATE
> Task :feature:search_expose:generateProDebugResValues UP-TO-DATE
> Task :feature:search_expose:generateProDebugResources UP-TO-DATE
```

**å¦å¤–ï¼šè™½ç„¶ä½†æ˜¯ï¼Œè¿˜æ˜¯å°½é‡å‡å°‘éœ€è¦exposeçš„å†…å®¹å§ï¼Œéå¿…è¦ä¸æš´éœ²ï¼å¦‚æœé¡¹ç›®æ ¹æœ¬ä¸éœ€è¦æš´éœ²ï¼Œè¯·ä¸è¦ä½¿ç”¨includeWithExposeï¼Œç›´æ¥includeï¼**



**groovy or ktsï¼Ÿ**

è€é¡¹ç›®ï¼Œå‡ ä¹ä¸å¯èƒ½åªå­˜åœ¨ktsï¼›å¦‚æœæ¸è¿›å¼å¼•å…¥ktsä»ç„¶ä¸è¡Œï¼ŒModuleExposeæ˜¯åŒæ ·æ”¯æŒgroovyçš„ï¼›

æ–‡æ¡£è¯·å‚è€ƒï¼šhttps://github.com/JailedBird/ModuleExpose/wiki

é¡¹ç›®è¯·å‚è€ƒï¼šhttps://github.com/JailedBird/ModuleExpose/tree/main/subproj/GradleSample



**è‡ªå®šä¹‰é…ç½®**

*expose.gradle.kts* ä¸­å®šä¹‰äº†å¾ˆå¤šè‡ªå®šä¹‰é…ç½®ï¼Œæ¯”å¦‚éœ€è¦æš´éœ²çš„ç›®å½•åç§°ã€æš´éœ²æ¨¡å—åç§°ã€æ—¥å¿—å¼€å…³ç­‰ï¼Œæ–¹ä¾¿å¤§å®¶è‡ªå®šä¹‰ï¼›

```
private val MODULE_EXPOSE_TAG = "expose"
private val DEFAULT_EXPOSE_DIR_NAME = "expose"
private val SCRIPT_DIR = "$rootDir/gradle/expose/"
private val BUILD_TEMPLATE_PATH_JAVA = "${SCRIPT_DIR}build_gradle_template_java"
private val BUILD_TEMPLATE_PATH_ANDROID = "${SCRIPT_DIR}build_gradle_template_android"
private val BUILD_TEMPLATE_PATH_CUSTOM = "build_gradle_template_expose"
private val ENABLE_FILE_CONDITION = false
private val MODULE_NAMESPACE_TEMPLATE = "cn.jailedbird.module.%s_expose"
private val DEBUG_ENABLE = false
```



## å‚è€ƒèµ„æ–™

1ã€æ€è·¯åŸåˆ›ï¼š[å¾®ä¿¡Androidæ¨¡å—åŒ–æ¶æ„é‡æ„å®è·µ](https://mp.weixin.qq.com/s/6Q818XA5FaHd7jJMFBG60w)

2ã€é¡¹ç›®åŸåˆ›ï¼š[github/tyhjh/module_api](https://github.com/tyhjh/module_api)

3ã€è„šæœ¬è¿ç§»ï¼š[å°† build é…ç½®ä» Groovy è¿ç§»åˆ° KTS](https://developer.android.com/studio/build/migrate-to-kts?hl=zh-cn)

4ã€å‚è€ƒæ–‡ç« ï¼š[Androidæ¨¡å—åŒ–è®¾è®¡æ–¹æ¡ˆä¹‹æ¥å£APIåŒ–](https://juejin.cn/post/6945413567285821453)

5ã€Nowinandroidï¼š[https://github.com/android/nowinandroid](https://github.com/android/nowinandroid)

6ã€Daggeré¡¹ç›®ï¼š[https://github.com/google/dagger](https://github.com/google/dagger)

7ã€Hiltå®˜æ–¹æ•™ç¨‹ï¼š[https://developer.android.com/training/dependency-injection/hilt-android](https://developer.android.com/training/dependency-injection/hilt-android?hl=zh-cn)











